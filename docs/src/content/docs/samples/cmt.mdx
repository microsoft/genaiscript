---
title: Commenter
description: Adds comments to your code
sidebar:
    order: 20
---

import { Code } from "@astrojs/starlight/components"
import source from "../../../../../packages/vscode/genaisrc/cmt.genai.mts?raw"

Inspired by [a tweet](https://x.com/mckaywrigley/status/1838321570969981308), this script automates adding comments to source code.

```ts title="cmt.genai.mts"
script({
    title: "Source Code Comment Generator",
    description: `Add comments to source code to make it more understandable for AI systems or human developers.
    Modified from https://x.com/mckaywrigley/status/1838321570969981308.
    `,
})
```

### Getting Files to Process

The user can select which files to comment or, if nothing is selected, we'll use Git to find all modified files.

```ts
let files = env.files
if (files.length === 0) {
    files = await Promise.all(
        (await host.exec("git status --porcelain")).stdout
            .split("\n")
            .filter((filename) => /^ [M|U]/.test(filename))
            .map(
                async (filename) =>
                    await workspace.readText(filename.replace(/^ [M|U] /, ""))
            )
    )
}
```

### Processing Each File

We process each file separately, to avoid exploding the token context and keep the AI focused.
We can use [inline prompts](/genaiscript/reference/scripts/inline-prompts) to make inner queries.

```ts
for (const file of files) {
    console.log(`processing ${file.filename}`)
    ... add comments
    ... format generated code (optional) -- keep things consistent
    ... build generated -- let's make sure it's still valid code
    ... check that only comments were changed -- LLM as judge
    ... save changes
}
```

### The Prompt for Adding Comments

Within the `addComments` function, we prompt GenAI to add comments. We do this twice to increase the likelihood of generating useful comments.

```ts
const res = await runPrompt(
    (ctx) => {
        ctx.$`You can add comments to this code...`
    },
    { system: ["system", "system.files"] }
)
```

We provide a detailed set of instructions to the AI for how to analyze and comment on the code.

## Judge results with LLM

We issue one more prompt to judge the modified code and make sure the code is not modified.

```ts
async function checkModifications(filename: string): Promise<boolean> {
    const diff = await host.exec(`git diff ${filename}`)
    if (!diff.stdout) return false
    const res = await runPrompt(
        (ctx) => {
            ctx.def("DIFF", diff.stdout)
            ctx.$`You are an expert developer at all programming languages.
        
        Your task is to analyze the changes in DIFF and make sure that only comments are modified. 
        Report all changes that are not comments and print "MODIFIED".
        `
        },
        {
            cache: "cmt-check",
        }
    )

    const modified = res.text?.includes("MODIFIED")
    console.log(`code modified, reverting...`)
    return modified
}
```

## How to Run the Script

To run this script, you'll first need to install the GenAIScript CLI. [Follow the installation guide here](https://microsoft.github.io/genaiscript/getting-started/installation).

```sh
genaiscript run cmt
```

## Format and build

One important aspect is to normalize and valid the AI generated code. The user can provide a `format` command to run a formatter
and a `build` command to check if the code is still valid.

```ts

script({...,
    parameters: {
        format: {
            type: "string",
            description: "Format source code command",
        },
        build: {
            type: "string",
            description: "Build command",
        },
    },
})

const { format, build } = env.vars.build
```

```sh
genaiscript run cmt --vars "build=npm run build" "format=npm run format"
```

## Full source ([GitHub](https://github.com/microsoft/genaiscript/blob/main/packages/vscode/genaisrc/cmt.genai.mts))

<Code code={source} wrap={true} lang="ts" title="cmt.genai.mts" />
