---
title: Commenter
description: Adds comments to your code
sidebar:
    order: 20
---

import { Code } from "@astrojs/starlight/components"
import source from "../../../../../packages/vscode/genaisrc/cmt.genai.mts?raw"

This sample automates adding comments to source code using an LLM
and validate the changes haven't introduce any code modifications.

To do so, we could use a combination of tools to validate the transformer: source formatters,
compilers, linters or LLM-as-judge.

The algorithm could be summarized as follows:

```txt
for each file of files
    // generate
    add comments using GenAI

    // validate validate validate!
    format generated code (optional) -- keep things consistent
    build generated -- let's make sure it's still valid code
    check that only comments were changed -- LLM as judge

// and more validate
final human code review
```

Let's get started with analyzing the script.

### Getting Files to Process

The user can select which files to comment or, if nothing is selected, we'll use Git to find all modified files.

```ts
let files = env.files
if (files.length === 0)
    // no files selected, use git to find modified files
    files = await ..."git status --porcelain"... // details in sources
```

### Processing Each File

We process each file separately, to avoid exploding the token context and keep the AI focused.
We can use [inline prompts](/genaiscript/reference/scripts/inline-prompts) to make inner queries.

```ts
for (const file of files) {
    ... add comments
    ... format generated code (optional) -- keep things consistent
    ... build generated -- let's make sure it's still valid code
    ... check that only comments were changed -- LLM as judge
    ... save changes
}
```

### The Prompt for Adding Comments

Within the `addComments` function, we prompt GenAI to add comments. 
We do this twice to increase the likelihood of generating useful comments,
or the LLM might have been lazy on the first pass.

```ts
const res = await runPrompt(
    (ctx) => {
        ctx.$`You can add comments to this code...` // prompt details in sources
    },
    { system: ["system", "system.files"] }
)
```

We provide a detailed set of instructions to the AI for how to analyze and comment on the code.

### Format, build, lint

At this point, we have a modified source code by an LLM. We should try to use all the available tools to validate the changes.
It is best to start with like formatters and compilers as they are deterministic and typically fast.

### Judge results with LLM

We issue one more prompt to judge the modified code (`git diff`) and make sure the code is not modified.

```ts
async function checkModifications(filename: string): Promise<boolean> {
    const diff = await host.exec(`git diff ${filename}`)
    if (!diff.stdout) return false
    const res = await runPrompt(
        (ctx) => {
            ctx.def("DIFF", diff.stdout)
            ctx.$`You are an expert developer at all programming languages.
        
        Your task is to analyze the changes in DIFF and make sure that only comments are modified. 
        Report all changes that are not comments and print "<MODIFIED>".
        `
        },
        {
            cache: "cmt-check",
        }
    )
    return res.text?.includes("<MODIFIED>")
}
```

## How to Run the Script

To run this script, you'll first need to install the GenAIScript CLI. [Follow the installation guide here](https://microsoft.github.io/genaiscript/getting-started/installation).

```sh
genaiscript run cmt
```

## Format and build

One important aspect is to normalize and valid the AI generated code. The user can provide a `format` command to run a formatter
and a `build` command to check if the code is still valid.

```ts

script({...,
    parameters: {
        format: {
            type: "string",
            description: "Format source code command",
        },
        build: {
            type: "string",
            description: "Build command",
        },
    },
})

const { format, build } = env.vars.build
```

```sh
genaiscript run cmt --vars "build=npm run build" "format=npm run format"
```

## Full source ([GitHub](https://github.com/microsoft/genaiscript/blob/main/packages/vscode/genaisrc/cmt.genai.mts))

<Code code={source} wrap={true} lang="ts" title="cmt.genai.mts" />
